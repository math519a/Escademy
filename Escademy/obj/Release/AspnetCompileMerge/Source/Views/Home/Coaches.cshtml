@using Escademy.Models;
@using MySql.Data.MySqlClient;
@{
    /**/

    ViewBag.Title = "Coaches";

    Escademy.Dal.EscademyMDB db = ViewBag.db;
}


@section styles  {

    <link rel="stylesheet" href="/Content/css/style.css">
    <link rel="stylesheet" href="/Content/css/magnific-popup.css">
    <link rel="stylesheet" href="/Content/css/jquery-ui.css">
    <link rel="stylesheet" href="/Content/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/Content/css/owl.theme.default.min.css">
    <link rel="stylesheet" href="~/Content/cssContact/style.css"

    <link rel="stylesheet" href="/Content/css/bootstrap-datepicker.css">

    <link rel="stylesheet" href="/Content/css/aos.css">
    <link rel="stylesheet" href="/Content/css/rangeslider.css">

    <link rel="stylesheet" href="/Content/css/card-style.css" />

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link media="all" rel="stylesheet" href="/Content/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>
    <link href="/Content/profile-img.css" type="text/css" rel="stylesheet" />

    <style>
        #bgContainerImg {
            background: linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0)), url('/Content/Images/3D mockup.jpg');
            background-position: 10%;
            background-repeat: no-repeat;
            background-attachment: fixed !important;
            background-size: 100% !important;
            /*background-position: center top !important;*/
        }

        .cf {
            position: relative;
            height: 230px;
        }

            .cf img {
                position: absolute;
                left: 0;
                -webkit-transition: opacity 250ms ease-in-out;
                -moz-transition: opacity 250ms ease-in-out;
                -o-transition: opacity 250ms ease-in-out;
                transition: opacity 250ms ease-in-out;
            }

                .cf img.top:hover {
                    opacity: 0;
                }

        .article-box .head .avatar {
            width: 24px;
            height: 24px;
            border-radius: 100%;
            overflow: visible;
            margin: 0 8px 0 0;
            position: relative;
        }
    </style>
}
<div class="site-wrap">
    <!--
        linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0))
    -->

    <div id="bgContainerImg" class="site-blocks-overlay aos-init aos-animate" style="height: 450px" data-aos="fade" data-stellar-background-ratio="0.5">
        <div class="container">
            <div class="row align-items-center justify-content-center text-center">
                <div class="col-md-12">
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8 text-center">
                            <h1 style="padding-top: 25px" id="bgTitle" class="aos-init aos-animate" data-aos="fade-up"></h1>
                            <p data-aos="fade-up" data-aos-delay="100" class="aos-init aos-animate"></p>
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </div>

    <div class="site-section bg-light" style="padding-bottom: 0px">
        <div class="container">
            @{
                int getGameCount(int gameId)
                {
                    //int output = 0;
                    //var dbConnection = new MySql.Data.MySqlClient.MySqlConnection(ConnectionString.Get("EscademyDB"));
                    //dbConnection.Open();
                    //using (var cmd = dbConnection.CreateCommand())
                    //{
                    //    cmd.CommandText = "SELECT COUNT(*) FROM esc_profilegames pg JOIN esc_accounts acc ON pg.accountId = acc.Id WHERE pg.Verified = 1 AND gameId = " + gameId;
                    //    var reader = cmd.ExecuteReader();
                    //    if (reader.Read())
                    //    {
                    //        output = reader.GetInt32(0);
                    //    }
                    //    dbConnection.Close();
                    //}
                    //return output;

                    return db.esc_profilegames.Count(c => c.Verified == 1 && c.gameId == gameId && c.serviceTypeId == 1);
                }
            }

            <div class="overlap-category mb-5">
                <div class="row align-items-stretch no-gutters">
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(1)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-house"></span></span>
                            <span class="caption mb-2 d-block">CS:GO</span>
                            <span class="number">@getGameCount(1)</span>
                        </a>
                    </div>
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(3)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-books"></span> </span>
                            <span class="caption mb-2 d-block">Fortnite</span>
                            <span class="number">@getGameCount(3)</span>
                        </a>
                    </div>
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(2)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-bunk-bed"></span></span>
                            <span class="caption mb-2 d-block">World of Warcraft</span>
                            <span class="number">@getGameCount(2)</span>
                        </a>
                    </div>
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(4)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-innovation"></span></span>
                            <span class="caption mb-2 d-block">Apex Legends</span>
                            <span class="number">@getGameCount(4)</span>
                        </a>
                    </div>
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(5)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-car"></span></span>
                            <span class="caption mb-2 d-block">Dota 2</span>
                            <span class="number">@getGameCount(5)</span>
                        </a>
                    </div>
                    <div class="col-sm-6 col-md-4 mb-4 mb-lg-0 col-lg-2">
                        <a href="javascript:void(0)" onclick="getCoachesByGameId(6)" class="popular-category h-100">
                            <span class="icon"><span class="flaticon-pizza"></span></span>
                            <span class="caption mb-2 d-block">LoL</span>
                            <span class="number">@getGameCount(6)</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NYT AFSNIT Boosters -->
<section class="sort-panel">
    <div class="container">
        <div class="row" style="border-bottom: solid 1px #ccc; margin-right: -50px;
    margin-left: -50px;">
            <div class="col-md-3 col-lg-3 mb-3">
                <div class="search-bar">
                    <i class="fa fa-search"></i>
                    <input onkeyup="filterName()" type="text" placeholder="Click Here to search" id="search-bar">
                </div>
                <!--search-bar-->

            </div>

            <div class="col-md-3 col-lg-3 mb-3">
                <div class="sort-selectbox">
                    <select class="form-control rounded" id="languageId_selected" name="LanguageId">
                        <option value="">Game</option>
                        <option value="2">Counter-Strike: Global Offensive</option>
                        <option value="3">World of Warcraft</option>
                        <option value="4">Fortnite</option>
                        <option value="5">Apex Legends</option>
                    </select>
                </div>
                <!--sort-selectbox-->
            </div>

            <div class="col-md-3 col-lg-3 mb-3">
                <div class="sort-selectbox">
                    <select class="form-control rounded" id="languageId_selected" name="LanguageId">
                        <option value="">Language</option>
                        <option value="2">Afrikanns</option>
                        <option value="3">Albanian</option>
                        <option value="4">Arabic</option>
                        <option value="5">Armenian</option>
                    </select>
                </div>
                <!--sort-selectbox-->
            </div>


            <div class="col-md-3 col-lg-3 mb-3">
                <div class="sort-selectbox">
                    <select class="form-control rounded" id="languageId_selected" name="LanguageId">
                        <option value="">Sort by</option>
                        <option value="2">Price</option>
                        <option value="3">Popularity</option>
                    </select>
                </div>
                <!--sort-selectbox-->
            </div>




        </div>
        <!--row-->
    </div>
    <!--container-->
</section>
<div class="bg-light" style="padding-top: 15px">
    <div class="row profile-container bg-light" style="max-width:1200px;margin-left:auto;margin-right:auto;" id="itemCategories">
        @{
            var gameCoaches = new List<GameCoaching>();

            gameCoaches = (
                from coach in db.esc_profilegames
                where coach.Verified == 1 && coach.serviceTypeId == 1

                join files in db.esc_profilegamesFiles on coach.Id equals files.profilegamesId into files
                join accounts in db.esc_accounts on coach.accountId equals accounts.Id
                join games in db.esc_games on coach.gameId equals games.Id
                join price in db.esc_profilegamesPricing on coach.Id equals price.profilegamesId into prices
                join order in db.esc_orders on accounts.Id equals order.receiver_id into orders

                select new GameCoaching
                {
                    Description = coach.Description,
                    Title = coach.Title,
                    Verified = coach.Verified,
                    AccountId = coach.accountId,
                    Id = coach.Id,
                    Price = prices.Min(c => c.Price).ToString(),
                    Abbreviation = games.Abbreviation,
                    UserFullName = accounts.FirstName,
                    TotalCoached = orders.Count(c => c.order_status == "completed"),
                    GameId = games.Id,
                    GamePicture = files.FirstOrDefault().FileName,
                    ServiceType = coach.serviceTypeId,
                    Game = games.Game,
                    UserPictureThumbnail = accounts.small_thumbnail,
                    IsLoggedIn = accounts.IsLoggedIn.HasValue ? (accounts.IsLoggedIn.Value ? 1 : 0) : 0
                }
            ).ToList();

            <section class="articles-block" style="width: 100%">
                <div class="articles-row" id="coachesData">
                    @{
                        foreach (var coaching in gameCoaches)
                        {
                            if (coaching.Verified == 1 && coaching.ServiceType == 1)
                            {
                                <article class="article-box" style="width: 25%">
                                    <div class="box">
                                        <div class="img-holder">

                                            @*<a href="@Url.Action("Detail", "Coaching", new { aId = coaching.AccountId, gId = coaching.GameId})">*@
                                            <a href="@Url.Action("Detail", "Coaching", new { id = coaching.Id})">
                                                <div class="cf">


                                                    @if (coaching.GamePicture == "0")
                                                    {
                                                        <img src="~/Images/noImage.jpg" />
                                                    }
                                                    else
                                                    {
                                                        <img src="~/CoachingImages/@coaching.GamePicture" />
                                                    }
                                                </div>
                                            </a>

                                        </div>
                                        <div class="article-caption">
                                            <header class="head">
                                                <div class="avatar">

                                                    @if (coaching.IsLoggedIn == 0)
                                                    {
                                                        if (String.IsNullOrEmpty(coaching.UserPictureThumbnail))
                                                        {
                                                            <img src="/Content/Images/portrait_2.png" alt="pic" />
                                                        }
                                                        else
                                                        {
                                                            <img src="data:image/png;base64,@coaching.UserPictureThumbnail" alt="img description">
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (String.IsNullOrEmpty(coaching.UserPictureThumbnail))
                                                        {
                                                            <img src="/Content/Images/portrait_2.png" alt="pic" />
                                                        }
                                                        else
                                                        {
                                                            <img src="data:image/png;base64,@coaching.UserPictureThumbnail" alt="img description_1">
                                                        }

                                                        <span style="position:absolute;width: 12px; height: 12px; top:-5px; right:-4px; height: 12px; line-height: 14px; background: #00CC00; border: solid 2px #fff;border-radius: 50%;"></span>
                                                    }
                                                </div>
                                                <div class="info-wrap">
                                                    <span class="name"><a href="@Url.Action("Profile", "Profiles", new {Id = coaching.AccountId})">@coaching.UserFullName</a></span>
                                                    <span class="level">Offers coaching for @coaching.Abbreviation</span>
                                                </div>
                                            </header>
                                            <div class="caption-body">
                                                <h3 style="height:40px;"><a href="@Url.Action("Detail", "Coaching", new { id = coaching.Id })">@coaching.Title</a></h3>
                                                <div class="user-rating">
                                                    <i class="fas fa-user-graduate"></i>
                                                    <span><strong>@coaching.TotalCoached</strong>coached</span>
                                                </div>
                                            </div>
                                        </div>
                                        <footer class="foot">
                                            <div class="icons-box">
                                                <a href="@Url.Action("Detail", "Coaching", new { id = coaching.Id})" class="list-icon">
                                                    <i class="far fa-credit-card"></i>
                                                </a>
                                                <a href="javascript:;" onclick="StartConversation(@coaching.AccountId);" class="list-icon"><i class="fas fa-comments"></i></a>
                                            </div>
                                            <div class="price">
                                                @*<a href="@Url.Action("Details", "Coaching", new { coaching.AccountId, coaching.GameId})">$@coaching.SalaryUSD.ToString().Substring(0, coaching.SalaryUSD.ToString().Length - 4)<small>per hour</small></a>*@
                                                <a href="@Url.Action("Detail", "Coaching", new { id = coaching.Id})">$@coaching.Price<small>per hour</small></a>
                                            </div>
                                        </footer>
                                    </div>
                                </article>
                            }
                            else
                            {
                                continue;
                            }
                        }
                    }                    
                </div>
            </section>
        }       
    </div>
    <section class="pagination-bottom mt-5 mb-5">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">4</a></li>
                            <li class="page-item"><a class="page-link" href="#">5</a></li>
                            <li class="page-item"><a class="page-link" href="#">6</a></li>
                            <li class="page-item"><a class="page-link" href="#">..</a></li>
                            <li class="page-item next">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            <!--row-->
        </div>
        <!--container-->
    </section>
</div>



@section scripts {
    <!-- Start Conversation JS reference-->
    <script src="/Scripts/conversation.js"></script>

    <script type="text/javascript">
        function getCoachesByGameId(gameId) {
            $(".loader-img").show();
            $.ajax({
                cache: false,
                type: "GET",
                url: "@(Url.Action("_GetCoaches"))",
                data: { "id": gameId },
                success: function (data) {

                    $("#coachesData").html('');

                    $("#coachesData").html(data);
                    $(".loader-img").hide();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve books.');
                }
            });

        }

        function filterName() {
            var input, filter, cards, cardContainer, h5, title, i;
            input = document.getElementById("search-bar");
                filter = input.value.toUpperCase();
                cardContainer = document.getElementById("itemCategories");
                cards = cardContainer.getElementsByClassName("box");
            for (i = 0; i < cards.length; i++) {
                title = cards[i].querySelector(".article-caption");
                if (title.innerText.toUpperCase().indexOf(filter) > -1) {
                    cards[i].parentElement.style.display = "";
                } else {
                    cards[i].parentElement.style.display = "none";
                }
            }
        }
            function filterCategory(filterInput) {
                var input, filter, cards, cardContainer, h5, title, i;
                filter = filterInput.toUpperCase();
                cardContainer = document.getElementById("itemCategories");
                cards = cardContainer.getElementsByClassName("card");
                for (i = 0; i < cards.length; i++) {
                    title = cards[i].querySelector(".category");
                    if (title.innerText.toUpperCase().indexOf(filter) > -1) {
                        cards[i].parentElement.style.display = "";
                    } else {
                        cards[i].parentElement.style.display = "none";
                    }
                }
            }
    </script>

    <script type="text/javascript">
        var titleOffset = $("#bgTitle").offset().top * 2;
        window.onscroll = function () {
            if (window.pageYOffset > 0) {
                var opac = (window.pageYOffset / titleOffset) / 2;
                var bg = document.getElementById("bgContainerImg");

                bg.style.background = "linear-gradient(rgba(242, 90, 41, " + opac + "), rgba(242, 90, 41, " + opac + ")), url('/Content/Images/3D mockup.jpg') no-repeat 10%";
            }
        };
    </script>

    @{
        if (ViewBag.filterCategory != null)
        {
            <script type="text/javascript">filterCategory("@ViewBag.filterCategory")</script>
        }
    }
}